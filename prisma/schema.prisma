generator client {
  provider = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

enum PlayerPosition {
  GK
  DEF
  MID
  FWD
}

model Profile {
  id          String   @id @db.Uuid // matches Supabase auth.users.id
  discordId   String?  @unique
  displayName String?
  avatarUrl   String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  leaguesCreated League[]
  memberships    LeagueMember[]
  teams          FantasyTeam[]
  draftPicks     DraftPick[]
}

model Season {
  id        String   @id @default(cuid())
  year      Int      @unique
  name      String   // e.g. "2026 Beta"
  isActive  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  players   Player[]
  leagues   League[]
  drafts    Draft[]
}

model Club {
  id        String   @id @default(cuid())
  name      String   @unique
  shortName String?  @unique
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  players   Player[]
}

model Player {
  id        String         @id @default(cuid())
  seasonId  String
  clubId    String
  name      String
  position  PlayerPosition
  active    Boolean        @default(true)
  slug      String?        @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  season    Season @relation(fields: [seasonId], references: [id], onDelete: Restrict)
  club      Club   @relation(fields: [clubId], references: [id], onDelete: Restrict)
  rosterSlots RosterSlot[]
  draftPicks DraftPick[]

  @@index([seasonId])
  @@index([clubId])
  @@unique([seasonId, name]) // simple guardrail for beta
}

enum LeagueRole {
  OWNER
  MEMBER
}

enum DraftStatus {
  NOT_STARTED
  LIVE
  COMPLETE
}

model League {
  id          String   @id @default(cuid())
  name        String
  inviteCode  String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById String   @db.Uuid
  seasonId    String

  createdBy   Profile      @relation(fields: [createdById], references: [id], onDelete: Restrict)
  season      Season       @relation(fields: [seasonId], references: [id], onDelete: Restrict)
  members     LeagueMember[]
  teams       FantasyTeam[]
  drafts      Draft[]

  @@index([createdById])
  @@index([seasonId])
}

model LeagueMember {
  id        String     @id @default(cuid())
  leagueId  String
  profileId String     @db.Uuid
  role      LeagueRole @default(MEMBER)
  createdAt DateTime   @default(now())

  league    League  @relation(fields: [leagueId], references: [id], onDelete: Restrict)
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Restrict)

  @@unique([leagueId, profileId])
  @@index([profileId])
}

model FantasyTeam {
  id        String   @id @default(cuid())
  leagueId  String
  profileId String   @db.Uuid
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  league  League  @relation(fields: [leagueId], references: [id], onDelete: Restrict)
  profile Profile @relation(fields: [profileId], references: [id], onDelete: Restrict)
  rosterSlots RosterSlot[]
  draftPicks DraftPick[]

  @@unique([leagueId, profileId])
  @@index([leagueId])
  @@index([profileId])
}

model RosterSlot {
  id            String         @id @default(cuid())
  fantasyTeamId String
  slotNumber    Int
  position      PlayerPosition @default(MID)
  playerId      String?
  isStarter     Boolean        @default(false)

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  fantasyTeam   FantasyTeam    @relation(fields: [fantasyTeamId], references: [id])
  player        Player?        @relation(fields: [playerId], references: [id])

  @@unique([fantasyTeamId, slotNumber])
  @@unique([fantasyTeamId, playerId])
}

model Draft {
  id        String      @id @default(cuid())
  leagueId  String
  seasonId  String
  status    DraftStatus @default(NOT_STARTED)
  rounds    Int         @default(15)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  league League @relation(fields: [leagueId], references: [id], onDelete: Restrict)
  season Season @relation(fields: [seasonId], references: [id], onDelete: Restrict)
  picks  DraftPick[]

  @@unique([leagueId, seasonId])
  @@index([leagueId])
  @@index([seasonId])
}

model DraftPick {
  id            String   @id @default(cuid())
  draftId       String
  pickNumber    Int
  round         Int
  slotInRound   Int
  fantasyTeamId String
  profileId     String   @db.Uuid
  playerId      String
  createdAt     DateTime @default(now())

  draft       Draft       @relation(fields: [draftId], references: [id], onDelete: Cascade)
  fantasyTeam FantasyTeam @relation(fields: [fantasyTeamId], references: [id], onDelete: Restrict)
  profile     Profile     @relation(fields: [profileId], references: [id], onDelete: Restrict)
  player      Player      @relation(fields: [playerId], references: [id], onDelete: Restrict)

  @@unique([draftId, pickNumber])
  @@unique([draftId, playerId])
  @@index([fantasyTeamId])
  @@index([profileId])
  @@index([playerId])
}
